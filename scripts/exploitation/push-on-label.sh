#!/bin/bash


help() {
  echo "$1" >&2
}

error() {
  echo "error: $1" >&2
}


if [[ $# -ne 5 ]]; then
  help "usage: $0 local_fork target_owner target_repo target_issue_number trigger"
  help "    local_fork           path to local fork repository (e.g. '/tmp/pwnhub')"
  help "    target_owner         mirror's owner (e.g. 'nikitastupin')"
  help "    target_repo          mirror's repo name (e.g. 'pwnhub')"
  help "    target_issue_number  pull request number you're waiting comment on (e.g. '1')"
  help "    label                trigger label (e.g. 'ci:ready_to_merge')"
  exit 1
fi


LOCAL_FORK="$1"
TARGET_OWNER="$2"
TARGET_REPO="$3"
TARGET_ISSUE_NUMBER="$4"
TRIGGER="$5"


if ! test -d "$LOCAL_FORK/.git"; then
  error "$LOCAL_FORK is not git repository"
  exit 1
fi

if ! gh auth status; then
  exit 1
fi


# https://github.com/cli/cli/issues/3796#issuecomment-1065150465
git -C "$LOCAL_FORK" config "credential.https://github.com.helper" ""
git -C "$LOCAL_FORK" config --add "credential.https://github.com.helper" "!/usr/local/bin/gh auth git-credential"

endpoint="repos/$TARGET_OWNER/$TARGET_REPO/issues/$TARGET_ISSUE_NUMBER/labels"

while true; do
  if gh api "$endpoint" --jq '.[] | .name' | grep -qF "$TRIGGER"; then
    break
  fi
  sleep "0.1337"
done

git -C "$LOCAL_FORK" add -A
git -C "$LOCAL_FORK" commit -m ':rocket:'
git -C "$LOCAL_FORK" push
